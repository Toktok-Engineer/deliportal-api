package repository

import (
	"deliportal-api/model"
	"strings"

	"gorm.io/gorm"
)

type CompanyLicenseRepository interface {
	FindCompanyLicenseByCompanyId(id uint) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	CountCompanyLicenseAll(companyId int, licenseGroup uint) (count int64, err error)
	FindCompanyLicenses() (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	FindCompanyLicensesOffset(limit int, offset int, order string, dir string, companyId int, licenseGroup uint) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	SearchCompanyLicense(limit int, offset int, order string, dir string, search string, companyId int, licenseGroup uint) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	CountSearchCompanyLicense(search string, companyId int, licenseGroup uint) (count int64, err error)
	CountCompanyLicenseAllMobile(companyId int) (count int64, err error)
	FindCompanyLicensesOffsetMobile(limit int, offset int, order string, dir string, companyId int) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	SearchCompanyLicenseMobile(limit int, offset int, order string, dir string, search string, companyId int) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	CountSearchCompanyLicenseMobile(search string, companyId int) (count int64, err error)
	CountCompanyLicenseApp(companyID string) (count int64, err error)
	FindCompanyLicensesApp(limit int, offset int, order string, dir string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	SearchCompanyLicenseApp(limit int, offset int, order string, dir string, search string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	CountSearchCompanyLicenseApp(search string, companyID string) (count int64, err error)
	CountExpCompanyLicense(companyID string) (count int64, err error)
	FindExpCompanyLicenses(limit int, offset int, order string, dir string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	CountSearchExpCompanyLicense(search string, companyID string) (count int64, err error)
	SearchExpCompanyLicense(limit int, offset int, order string, dir string, search string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	FindCompanyLicenseById(id uint) (companyLicenseOutput model.SelectCompanyLicenseParameter, err error)
	FindExcCompanyLicense(id uint) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	CountCompanyLicenseFull(companyID string) (count int64, err error)
	FindCompanyLicensesOffsetFull(limit int, offset int, order string, dir string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	SearchCompanyLicenseFull(limit int, offset int, order string, dir string, search string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error)
	CountSearchCompanyLicenseFull(search string, companyID string) (count int64, err error)
	InsertCompanyLicense(companyLicense model.CompanyLicense) (companyLicenseOutput model.CompanyLicense, err error)
	UpdateCompanyLicense(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error)
	UpdateCompanyLicenseStatus(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error)
	UpdateCompanyLicenseDeactive(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error)
	UpdateCompanyLicenseApprovedRenewalStatus(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error)
	DeleteCompanyLicense(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error)
	UpdateCompanyRemark(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error)
}

type CompanyLicenseConnection struct {
	connection *gorm.DB
}

func NewCompanyLicenseRepository(db *gorm.DB) CompanyLicenseRepository {
	return &CompanyLicenseConnection{
		connection: db,
	}
}

func (db *CompanyLicenseConnection) FindCompanyLicenseByCompanyId(id uint) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		companyLicenses []model.SelectCompanyLicenseParameter
	)

	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status, CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name, CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status, CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("company_licenses.company_id=? AND  company_licenses.deleted_at = 0", id).Order("company_licenses.group_license_type_id, license_types.license_type_name, company_licenses.license_no").Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) CountCompanyLicenseAll(companyId int, licenseGroup uint) (count int64, err error) {
	res := db.connection.Table("company_licenses").Where("company_id = ? AND group_license_type_id=? AND deleted_at = 0", companyId, licenseGroup).Count(&count)
	return count, res.Error
}

func (db *CompanyLicenseConnection) FindCompanyLicenses() (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status, CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name, CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'	WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("company_licenses.deleted_at = 0").Order("company_licenses.license_no").Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) FindCompanyLicensesOffset(limit int, offset int, order string, dir string, companyId int, licenseGroup uint) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		orderDirection  string
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	orderDirection = order + " " + dir
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("company_licenses.company_id = ? AND company_licenses.group_license_type_id=? AND company_licenses.deleted_at = 0", companyId, licenseGroup).Order(orderDirection).Limit(limit).Offset(offset).Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) SearchCompanyLicense(limit int, offset int, order string, dir string, search string, companyId int, licenseGroup uint) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		orderDirection  string
		final           string
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	orderDirection = order + " " + dir
	final = "%" + strings.ToLower(search) + "%"
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(lower(group_license_types.group_license_type_name) LIKE ? OR lower(business_units.business_unit_name) LIKE ? OR lower(license_types.license_type_name) LIKE ? OR lower(company_licenses.license_no) LIKE ? OR lower(parents.license_no) LIKE ? OR company_licenses.renewable::TEXT LIKE ? OR lower(company_licenses.issued_by) LIKE ? OR lower(to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END) LIKE ? OR lower(appUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(company_licenses.remark) LIKE ? OR lower(createdUID.username) LIKE ?  OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND company_licenses.company_id = ? AND company_licenses.group_license_type_id=? AND company_licenses.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, companyId, licenseGroup).Order(orderDirection).Limit(limit).Offset(offset).Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) CountSearchCompanyLicense(search string, companyId int, licenseGroup uint) (count int64, err error) {
	final := "%" + strings.ToLower(search) + "%"
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(lower(group_license_types.group_license_type_name) LIKE ? OR lower(business_units.business_unit_name) LIKE ? OR lower(license_types.license_type_name) LIKE ? OR lower(company_licenses.license_no) LIKE ? OR lower(parents.license_no) LIKE ? OR company_licenses.renewable::TEXT LIKE ? OR lower(company_licenses.issued_by) LIKE ? OR lower(to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END) LIKE ? OR lower(appUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(company_licenses.remark) LIKE ? OR lower(createdUID.username) LIKE ?  OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND company_licenses.company_id = ?  AND company_licenses.group_license_type_id=? AND company_licenses.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, companyId, licenseGroup).Count(&count)
	return count, res.Error
}

func (db *CompanyLicenseConnection) CountCompanyLicenseAllMobile(companyId int) (count int64, err error) {
	res := db.connection.Table("company_licenses").Where("company_id = ? AND deleted_at = 0", companyId).Count(&count)
	return count, res.Error
}

func (db *CompanyLicenseConnection) FindCompanyLicensesOffsetMobile(limit int, offset int, order string, dir string, companyId int) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		orderDirection  string
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	orderDirection = order + " " + dir
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("company_licenses.company_id = ? AND company_licenses.deleted_at = 0", companyId).Order(orderDirection).Limit(limit).Offset(offset).Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) SearchCompanyLicenseMobile(limit int, offset int, order string, dir string, search string, companyId int) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		orderDirection  string
		final           string
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	orderDirection = order + " " + dir
	final = "%" + strings.ToLower(search) + "%"
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(lower(group_license_types.group_license_type_name) LIKE ? OR lower(business_units.business_unit_name) LIKE ? OR lower(license_types.license_type_name) LIKE ? OR lower(company_licenses.license_no) LIKE ? OR lower(parents.license_no) LIKE ? OR company_licenses.renewable::TEXT LIKE ? OR lower(company_licenses.issued_by) LIKE ? OR lower(to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END) LIKE ? OR lower(appUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(company_licenses.remark) LIKE ? OR lower(createdUID.username) LIKE ?  OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND company_licenses.company_id = ? AND company_licenses.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, companyId).Order(orderDirection).Limit(limit).Offset(offset).Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) CountSearchCompanyLicenseMobile(search string, companyId int) (count int64, err error) {
	final := "%" + strings.ToLower(search) + "%"
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(lower(group_license_types.group_license_type_name) LIKE ? OR lower(business_units.business_unit_name) LIKE ? OR lower(license_types.license_type_name) LIKE ? OR lower(company_licenses.license_no) LIKE ? OR lower(parents.license_no) LIKE ? OR company_licenses.renewable::TEXT LIKE ? OR lower(company_licenses.issued_by) LIKE ? OR lower(to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END) LIKE ? OR lower(appUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(company_licenses.remark) LIKE ? OR lower(createdUID.username) LIKE ?  OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND company_licenses.company_id = ? AND company_licenses.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, companyId).Count(&count)
	return count, res.Error
}

func (db *CompanyLicenseConnection) CountCompanyLicenseApp(companyID string) (count int64, err error) {
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(company_licenses.status = 2 OR company_licenses.renewal_status = 3 OR company_licenses.renewal_status = 4) AND company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", compId).Count(&count)
	return count, res.Error
}

func (db *CompanyLicenseConnection) FindCompanyLicensesApp(limit int, offset int, order string, dir string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		orderDirection  string
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	orderDirection = order + " " + dir
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(company_licenses.status = 2 OR company_licenses.renewal_status = 3 OR company_licenses.renewal_status = 4) AND company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", compId).Order(orderDirection).Limit(limit).Offset(offset).Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) SearchCompanyLicenseApp(limit int, offset int, order string, dir string, search string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		orderDirection  string
		final           string
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	orderDirection = order + " " + dir
	final = "%" + strings.ToLower(search) + "%"
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(lower(group_license_types.group_license_type_name) LIKE ? OR lower(business_units.business_unit_name) LIKE ? OR lower(companies.company_name) LIKE ? OR lower(license_types.license_type_name) LIKE ? OR lower(company_licenses.license_no) LIKE ? OR lower(parents.license_no) LIKE ? OR company_licenses.renewable::TEXT LIKE ? OR lower(company_licenses.issued_by) LIKE ? OR lower(to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END) LIKE ? OR lower(appUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(company_licenses.remark) LIKE ? OR lower(createdUID.username) LIKE ?  OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND company_licenses.status = 2 OR company_licenses.renewal_status = 3 OR company_licenses.renewal_status = 4 AND company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, compId).Order(orderDirection).Limit(limit).Offset(offset).Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) CountSearchCompanyLicenseApp(search string, companyID string) (count int64, err error) {
	final := "%" + strings.ToLower(search) + "%"
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(lower(group_license_types.group_license_type_name) LIKE ? OR lower(business_units.business_unit_name) LIKE ? OR lower(companies.company_name) LIKE ? OR lower(license_types.license_type_name) LIKE ? OR lower(company_licenses.license_no) LIKE ? OR lower(parents.license_no) LIKE ? OR company_licenses.renewable::TEXT LIKE ? OR lower(company_licenses.issued_by) LIKE ? OR lower(to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END) LIKE ? OR lower(appUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(company_licenses.remark) LIKE ? OR lower(createdUID.username) LIKE ?  OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND company_licenses.status = 2 OR company_licenses.renewal_status = 3 OR company_licenses.renewal_status = 4 AND company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, compId).Count(&count)
	return count, res.Error
}

func (db *CompanyLicenseConnection) CountExpCompanyLicense(companyID string) (count int64, err error) {
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("company_licenses.renewable = true AND company_licenses.renewal_status not in (5,6) AND company_licenses.status = 3 AND date(now()) >= date((timezone('Asia/Jakarta', to_timestamp(company_licenses.earliest_renewal_date)) - (license_types.reminder_before_month::text || ' month')::interval)) AND company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", compId).Count(&count)
	return count, res.Error
}

func (db *CompanyLicenseConnection) FindExpCompanyLicenses(limit int, offset int, order string, dir string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		orderDirection  string
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	orderDirection = order + " " + dir
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("company_licenses.renewable = true AND company_licenses.renewal_status not in (5,6) AND company_licenses.status = 3 AND date(now()) >= date((timezone('Asia/Jakarta', to_timestamp(company_licenses.earliest_renewal_date)) - (license_types.reminder_before_month::text || ' month')::interval)) AND company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", compId).Order(orderDirection).Limit(limit).Offset(offset).Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) SearchExpCompanyLicense(limit int, offset int, order string, dir string, search string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		orderDirection  string
		final           string
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	orderDirection = order + " " + dir
	final = "%" + strings.ToLower(search) + "%"
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(lower(group_license_types.group_license_type_name) LIKE ? OR lower(business_units.business_unit_name) LIKE ? OR lower(companies.company_name) LIKE ? OR lower(license_types.license_type_name) LIKE ? OR lower(company_licenses.license_no) LIKE ? OR lower(parents.license_no) LIKE ? OR company_licenses.renewable::TEXT LIKE ? OR lower(company_licenses.issued_by) LIKE ? OR lower(to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END) LIKE ? OR lower(appUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(company_licenses.remark) LIKE ? OR lower(createdUID.username) LIKE ?  OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND company_licenses.renewable = true AND company_licenses.renewal_status not in (5,6) AND company_licenses.status = 3 AND date(now()) >= date((timezone('Asia/Jakarta', to_timestamp(company_licenses.earliest_renewal_date)) - (license_types.reminder_before_month::text || ' month')::interval)) AND company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, compId).Order(orderDirection).Limit(limit).Offset(offset).Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) CountSearchExpCompanyLicense(search string, companyID string) (count int64, err error) {
	final := "%" + strings.ToLower(search) + "%"
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(lower(group_license_types.group_license_type_name) LIKE ? OR lower(business_units.business_unit_name) LIKE ? OR lower(companies.company_name) LIKE ? OR lower(license_types.license_type_name) LIKE ? OR lower(company_licenses.license_no) LIKE ? OR lower(parents.license_no) LIKE ? OR company_licenses.renewable::TEXT LIKE ? OR lower(company_licenses.issued_by) LIKE ? OR lower(to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END) LIKE ? OR lower(appUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(company_licenses.remark) LIKE ? OR lower(createdUID.username) LIKE ?  OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND company_licenses.renewable = true AND company_licenses.renewal_status not in (5,6) AND company_licenses.status = 3 AND date(now()) >= date((timezone('Asia/Jakarta', to_timestamp(company_licenses.earliest_renewal_date)) - (license_types.reminder_before_month::text || ' month')::interval)) AND company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, compId).Count(&count)
	return count, res.Error
}

func (db *CompanyLicenseConnection) FindCompanyLicenseById(id uint) (companyLicenseOutput model.SelectCompanyLicenseParameter, err error) {
	var (
		companyLicense model.SelectCompanyLicenseParameter
	)

	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("company_licenses.id=? AND company_licenses.deleted_at = 0", id).Take(&companyLicense)
	return companyLicense, res.Error
}

func (db *CompanyLicenseConnection) FindExcCompanyLicense(id uint) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		companyLicenses []model.SelectCompanyLicenseParameter
	)

	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("company_licenses.id!=? AND company_licenses.deleted_at = 0", id).Order("company_licenses.id").Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) CountCompanyLicenseFull(companyID string) (count int64, err error) {
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Where("company_id NOT IN (?) AND deleted_at = 0", compId).Count(&count)
	return count, res.Error
}

func (db *CompanyLicenseConnection) FindCompanyLicensesOffsetFull(limit int, offset int, order string, dir string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		orderDirection  string
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	orderDirection = order + " " + dir
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", compId).Order(orderDirection).Limit(limit).Offset(offset).Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) SearchCompanyLicenseFull(limit int, offset int, order string, dir string, search string, companyID string) (companyLicenseOutput []model.SelectCompanyLicenseParameter, err error) {
	var (
		orderDirection  string
		final           string
		companyLicenses []model.SelectCompanyLicenseParameter
	)
	orderDirection = order + " " + dir
	final = "%" + strings.ToLower(search) + "%"
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(lower(group_license_types.group_license_type_name) LIKE ? OR lower(business_units.business_unit_name) LIKE ? OR lower(companies.company_name) LIKE ? OR lower(license_types.license_type_name) LIKE ? OR lower(company_licenses.license_no) LIKE ? OR lower(parents.license_no) LIKE ? OR company_licenses.renewable::TEXT LIKE ? OR lower(company_licenses.issued_by) LIKE ? OR lower(to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END) LIKE ? OR lower(appUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(company_licenses.remark) LIKE ? OR lower(createdUID.username) LIKE ?  OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, compId).Order(orderDirection).Limit(limit).Offset(offset).Find(&companyLicenses)
	return companyLicenses, res.Error
}

func (db *CompanyLicenseConnection) CountSearchCompanyLicenseFull(search string, companyID string) (count int64, err error) {
	final := "%" + strings.ToLower(search) + "%"
	compId := strings.Split(companyID, ",")
	res := db.connection.Table("company_licenses").Select("company_licenses.id, companies.company_name, business_units.business_unit_name, company_licenses.parent_license_id, company_licenses.license_no, parents.license_no AS license_parent_no, company_licenses.license_type_id, license_types.license_type_name, company_licenses.company_id, company_licenses.renewable, company_licenses.reminder_counter, company_licenses.issued_by, to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY') as issued_date, to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY') as expired_date, to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY') as earliest_renewal_date, to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY') as last_renewal_date, company_licenses.status,  CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END AS status_name,  CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END AS severity, company_licenses.renewal_status,CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END AS renewal_status_name, company_licenses.approved_user_id, appUID.username AS approved_user, company_licenses.renewal_approved_user_id, renewalAppUID.username AS renewal_approved_user, to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY') AS approved_date, to_char(to_timestamp(company_licenses.renewal_approved_date::numeric), 'DD-Mon-YYYY') AS renewal_approved_date, company_licenses.remark, company_licenses.created_user_id, createdUID.username AS created_user, company_licenses.updated_user_id, updatedUID.username AS updated_user, company_licenses.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(company_licenses.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, company_licenses.group_license_type_id, group_license_types.group_license_type_name, company_licenses.file_name, company_licenses.file_url").Joins("left join users appUID on company_licenses.approved_user_id = appUID.id").Joins("left join users renewalAppUID on company_licenses.renewal_approved_user_id = renewalAppUID.id").Joins("left join group_license_types ON company_licenses.group_license_type_id = group_license_types.id").Joins("left join company_licenses parents on company_licenses.parent_license_id = parents.id").Joins("inner join license_types ON company_licenses.license_type_id = license_types.id").Joins("inner join companies ON company_licenses.company_id = companies.id").Joins("left join business_units on companies.business_unit_id = business_units.id").Joins("left join users createdUID on company_licenses.created_user_id = createdUID.id").Joins("left join users updatedUID on company_licenses.updated_user_id = updatedUID.id").Joins("left join users deletedUID on company_licenses.deleted_user_id = deletedUID.id").Where("(lower(group_license_types.group_license_type_name) LIKE ? OR lower(business_units.business_unit_name) LIKE ? OR lower(companies.company_name) LIKE ? OR lower(license_types.license_type_name) LIKE ? OR lower(company_licenses.license_no) LIKE ? OR lower(parents.license_no) LIKE ? OR company_licenses.renewable::TEXT LIKE ? OR lower(company_licenses.issued_by) LIKE ? OR lower(to_char(to_timestamp(company_licenses.issued_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.expired_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.earliest_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.last_renewal_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(CASE WHEN company_licenses.status = 1 THEN 'Draft' WHEN company_licenses.status = 2 THEN 'Need Approval' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 5 THEN 'Renew' WHEN company_licenses.status = 3 AND company_licenses.renewal_status = 6 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'Open to Renew' WHEN company_licenses.status = 3 AND (company_licenses.expired_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'Expired' WHEN company_licenses.status = 3 THEN 'Active' WHEN company_licenses.status = 4 THEN 'Not Active' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.earliest_renewal_date < company_licenses.last_renewal_date) AND company_licenses.renewable = true THEN 'LOW' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date >= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date <= EXTRACT(epoch FROM now())) AND (company_licenses.last_renewal_date < company_licenses.expired_date) AND company_licenses.renewable = true THEN 'HIGH' WHEN company_licenses.status = 3 AND company_licenses.renewal_status != 5 AND company_licenses.renewal_status != 6 AND (company_licenses.expired_date < EXTRACT(epoch FROM now())) AND company_licenses.renewable = true THEN 'CRITICAL' ELSE '' END) LIKE ? OR lower(CASE WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 1 THEN 'Open' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 2 THEN 'Follow Up' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 3 THEN 'Renew' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 4 THEN 'Close Permit' WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 5 THEN 'Renew Approved'WHEN company_licenses.status = 3 AND (company_licenses.earliest_renewal_date <= EXTRACT(epoch FROM now())) AND company_licenses.renewable = true AND company_licenses.renewal_status = 6 THEN 'Close Permit Approved' ELSE '' END) LIKE ? OR lower(appUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.approved_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(company_licenses.remark) LIKE ? OR lower(createdUID.username) LIKE ?  OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(company_licenses.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(to_char(to_timestamp(company_licenses.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND company_licenses.company_id NOT IN (?) AND company_licenses.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, compId).Count(&count)
	return count, res.Error
}

func (db *CompanyLicenseConnection) InsertCompanyLicense(companyLicense model.CompanyLicense) (companyLicenseOutput model.CompanyLicense, err error) {
	res := db.connection.Save(&companyLicense)
	return companyLicense, res.Error
}

func (db *CompanyLicenseConnection) UpdateCompanyLicense(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error) {
	var (
		company_license model.CompanyLicense
	)
	res := db.connection.Model(&company_license).Where("id=?", id).Updates(map[string]interface{}{"group_license_type_id": companyLicense.GroupLicenseTypeID, "parent_license_id": companyLicense.ParentLicenseID, "license_no": companyLicense.LicenseNo, "license_type_id": companyLicense.LicenseTypeID, "company_id": companyLicense.CompanyID, "renewable": companyLicense.Renewable, "reminder_counter": companyLicense.ReminderCounter, "issued_by": companyLicense.IssuedBy, "issued_date": companyLicense.IssuedDate, "expired_date": companyLicense.ExpiredDate, "earliest_renewal_date": companyLicense.EarliestRenewalDate, "last_renewal_date": companyLicense.LastRenewalDate, "status": companyLicense.Status, "renewal_status": companyLicense.RenewalStatus, "remark": companyLicense.Remark, "updated_user_id": companyLicense.UpdatedUserID, "updated_at": companyLicense.UpdatedAt, "file_name": companyLicense.FileName, "file_url": companyLicense.FileUrl})
	return companyLicense, res.Error
}

func (db *CompanyLicenseConnection) UpdateCompanyLicenseStatus(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error) {
	var (
		company_license model.CompanyLicense
	)
	res := db.connection.Model(&company_license).Where("id=?", id).Updates(map[string]interface{}{"status": companyLicense.Status, "approved_user_id": companyLicense.ApprovedUserID, "approved_date": companyLicense.ApprovedDate})
	return companyLicense, res.Error
}

func (db *CompanyLicenseConnection) UpdateCompanyLicenseDeactive(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error) {
	var (
		company_license model.CompanyLicense
	)
	res := db.connection.Model(&company_license).Where("id=?", id).Updates(map[string]interface{}{"status": companyLicense.Status})
	return companyLicense, res.Error
}

func (db *CompanyLicenseConnection) UpdateCompanyLicenseApprovedRenewalStatus(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error) {
	var (
		company_license model.CompanyLicense
	)
	res := db.connection.Model(&company_license).Where("id=?", id).Updates(map[string]interface{}{"renewal_status": companyLicense.RenewalStatus, "renewal_approved_user_id": companyLicense.RenewalApprovedUserID, "renewal_approved_date": companyLicense.RenewalApprovedDate})
	return companyLicense, res.Error
}

func (db *CompanyLicenseConnection) DeleteCompanyLicense(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error) {
	var (
		company_license model.CompanyLicense
	)
	res := db.connection.Model(&company_license).Where("id=?", id).Updates(map[string]interface{}{"license_no": companyLicense.LicenseNo, "deleted_user_id": companyLicense.DeletedUserID, "deleted_at": companyLicense.DeletedAt})
	return companyLicense, res.Error
}

func (db *CompanyLicenseConnection) UpdateCompanyRemark(companyLicense model.CompanyLicense, id uint) (companyLicenseOutput model.CompanyLicense, err error) {
	res := db.connection.Model(&companyLicense).Where("id=?", id).Updates(map[string]interface{}{"remark": companyLicense.Remark})
	return companyLicense, res.Error
}
