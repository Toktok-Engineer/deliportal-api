package repository

import (
	"deliportal-api/model"
	"strings"

	"gorm.io/gorm"
)

type InternalMemoRepository interface {
	CountInternalMemoAll(employeeID int) (internalMemoOutput []model.SelectInternalMemoParameter, err error)
	FindInternalMemos() (internalMemoOutput []model.SelectInternalMemoParameter, err error)
	FindInternalMemosOffset(limit int, offset int, order string, dir string, employeeID int) (internalMemoOutput []model.SelectInternalMemoParameter, err error)
	SearchInternalMemo(limit int, offset int, order string, dir string, search string, employeeID int) (internalMemoOutput []model.SelectInternalMemoParameter, err error)
	CountSearchInternalMemo(search string, employeeID int) (internalMemoOutput []model.SelectInternalMemoParameter, err error)
	CountInternalMemoByDept(deptName string) (count int64, err error)
	FindInternalMemoById(id uint) (internalMemoOutput model.SelectInternalMemoParameter, err error)
	FindExcInternalMemo(id uint) (internalMemoOutput []model.SelectInternalMemoParameter, err error)
	InsertInternalMemo(internalMemo model.InternalMemo) (internalMemoOutput model.InternalMemo, err error)
	UpdateInternalMemo(internalMemo model.InternalMemo, id uint) (internalMemoOutput model.InternalMemo, err error)
	UpdateInternalMemoApprove(internalMemo model.InternalMemo, id uint) (internalMemoOutput model.InternalMemo, err error)
	UploadIMDocument(internalMemo model.InternalMemo, id uint) (internalMemoOutput model.InternalMemo, err error)
}

type InternalMemoConnection struct {
	connection *gorm.DB
}

func NewInternalMemoRepository(db *gorm.DB) InternalMemoRepository {
	return &InternalMemoConnection{
		connection: db,
	}
}

func (db *InternalMemoConnection) CountInternalMemoAll(employeeID int) (internalMemoOutput []model.SelectInternalMemoParameter, err error) {
	var (
		internalMemos []model.SelectInternalMemoParameter
	)
	res := db.connection.Debug().Table("internal_memos").Select("internal_memos.id, internal_memos.internal_memo_no, to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY') as internal_memo_date, internal_memos.internal_memo_type_id, internal_memos.perihal_others, internal_memo_types.internal_memo_type_name, internal_memos.return_to_employee_id, returnToEmployeeID.firstname AS return_to_employee_name, internal_memos.document_no, internal_memos.company_id, companies.company_name, internal_memos.related_party, internal_memos.amount, internal_memos.amount_note, internal_memos.internal_memo_description, internal_memos.internal_memo_result, internal_memos.total_circulation, internal_memos.last_circulation_sequence_no, internal_memos.last_circulation_employee_id, lastCirculationEmployeeName.firstname AS last_circulation_employee_name, internal_memos.status, CASE WHEN internal_memos.status = 1 THEN 'Draft' WHEN internal_memos.status = 2 THEN 'Ask for Approval' WHEN internal_memos.status = 3 THEN 'Back to PIC' WHEN internal_memos.status = 4 THEN 'Approval Completed' WHEN internal_memos.status = 5 THEN 'Rejected' END AS status_name, internal_memos.remark, internal_memos.created_user_id, createdUID.username AS created_user, internal_memos.updated_user_id, updatedUID.username AS updated_user, internal_memos.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(internal_memos.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(internal_memos.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(internal_memos.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, internal_memos.file_name, internal_memos.file_url").Joins("left join companies on internal_memos.company_id = companies.id").Joins("left join internal_memo_types on internal_memos.internal_memo_type_id = internal_memo_types.id").Joins("left join employees returnToEmployeeID on internal_memos.return_to_employee_id = returnToEmployeeID.id").Joins("left join employees lastCirculationEmployeeName on internal_memos.last_circulation_employee_id = lastCirculationEmployeeName.id").Joins("left join users createdUID on internal_memos.created_user_id = createdUID.id").Joins("left join users updatedUID on internal_memos.updated_user_id = updatedUID.id").Joins("left join users deletedUID on internal_memos.deleted_user_id = deletedUID.id").Where("internal_memos.return_to_employee_id = ? AND internal_memos.deleted_at = 0", employeeID).Find(&internalMemos)
	return internalMemos, res.Error
}

func (db *InternalMemoConnection) FindInternalMemos() (internalMemoOutput []model.SelectInternalMemoParameter, err error) {
	var (
		internalMemos []model.SelectInternalMemoParameter
	)
	res := db.connection.Debug().Table("internal_memos").Select("internal_memos.id, internal_memos.internal_memo_no, to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY') as internal_memo_date, internal_memos.internal_memo_type_id, internal_memos.perihal_others, internal_memo_types.internal_memo_type_name, internal_memos.return_to_employee_id, returnToEmployeeID.firstname AS return_to_employee_name, internal_memos.document_no, internal_memos.company_id, companies.company_name, internal_memos.related_party, internal_memos.amount, internal_memos.amount_note, internal_memos.internal_memo_description, internal_memos.internal_memo_result, internal_memos.total_circulation, internal_memos.last_circulation_sequence_no, internal_memos.last_circulation_employee_id, lastCirculationEmployeeName.firstname AS last_circulation_employee_name, internal_memos.status, CASE WHEN internal_memos.status = 1 THEN 'Draft' WHEN internal_memos.status = 2 THEN 'Ask for Approval' WHEN internal_memos.status = 3 THEN 'Back to PIC' WHEN internal_memos.status = 4 THEN 'Approval Completed' WHEN internal_memos.status = 5 THEN 'Rejected' END AS status_name, internal_memos.remark, internal_memos.created_user_id, createdUID.username AS created_user, internal_memos.updated_user_id, updatedUID.username AS updated_user, internal_memos.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(internal_memos.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(internal_memos.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(internal_memos.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, internal_memos.file_name, internal_memos.file_url").Joins("left join companies on internal_memos.company_id = companies.id").Joins("left join internal_memo_types on internal_memos.internal_memo_type_id = internal_memo_types.id").Joins("left join employees returnToEmployeeID on internal_memos.return_to_employee_id = returnToEmployeeID.id").Joins("left join employees lastCirculationEmployeeName on internal_memos.last_circulation_employee_id = lastCirculationEmployeeName.id").Joins("left join users createdUID on internal_memos.created_user_id = createdUID.id").Joins("left join users updatedUID on internal_memos.updated_user_id = updatedUID.id").Joins("left join users deletedUID on internal_memos.deleted_user_id = deletedUID.id").Where("internal_memos.deleted_at = 0").Order("internal_memos.internal_memo_no").Find(&internalMemos)
	return internalMemos, res.Error
}

func (db *InternalMemoConnection) FindInternalMemosOffset(limit int, offset int, order string, dir string, employeeID int) (internalMemoOutput []model.SelectInternalMemoParameter, err error) {
	var (
		orderDirection string
		internalMemos  []model.SelectInternalMemoParameter
	)
	orderDirection = order + " " + dir
	res := db.connection.Debug().Table("internal_memos").Select("internal_memos.id, internal_memos.internal_memo_no, to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY') as internal_memo_date, internal_memos.internal_memo_type_id, internal_memos.perihal_others, internal_memo_types.internal_memo_type_name, internal_memos.return_to_employee_id, returnToEmployeeID.firstname AS return_to_employee_name, internal_memos.document_no, internal_memos.company_id, companies.company_name, internal_memos.related_party, internal_memos.amount, internal_memos.amount_note, internal_memos.internal_memo_description, internal_memos.internal_memo_result, internal_memos.total_circulation, internal_memos.last_circulation_sequence_no, internal_memos.last_circulation_employee_id, lastCirculationEmployeeName.firstname AS last_circulation_employee_name, internal_memos.status, CASE WHEN internal_memos.status = 1 THEN 'Draft' WHEN internal_memos.status = 2 THEN 'Ask for Approval' WHEN internal_memos.status = 3 THEN 'Back to PIC' WHEN internal_memos.status = 4 THEN 'Approval Completed' WHEN internal_memos.status = 5 THEN 'Rejected' END AS status_name, internal_memos.remark, internal_memos.created_user_id, createdUID.username AS created_user, internal_memos.updated_user_id, updatedUID.username AS updated_user, internal_memos.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(internal_memos.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(internal_memos.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(internal_memos.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, internal_memos.file_name, internal_memos.file_url").Joins("left join companies on internal_memos.company_id = companies.id").Joins("left join internal_memo_types on internal_memos.internal_memo_type_id = internal_memo_types.id").Joins("left join employees returnToEmployeeID on internal_memos.return_to_employee_id = returnToEmployeeID.id").Joins("left join employees lastCirculationEmployeeName on internal_memos.last_circulation_employee_id = lastCirculationEmployeeName.id").Joins("left join users createdUID on internal_memos.created_user_id = createdUID.id").Joins("left join users updatedUID on internal_memos.updated_user_id = updatedUID.id").Joins("left join users deletedUID on internal_memos.deleted_user_id = deletedUID.id").Where("internal_memos.return_to_employee_id = ? AND internal_memos.deleted_at = 0", employeeID).Order(orderDirection).Limit(limit).Offset(offset).Find(&internalMemos)
	return internalMemos, res.Error
}

func (db *InternalMemoConnection) SearchInternalMemo(limit int, offset int, order string, dir string, search string, employeeID int) (internalMemoOutput []model.SelectInternalMemoParameter, err error) {
	var (
		orderDirection string
		final          string
		internalMemos  []model.SelectInternalMemoParameter
	)
	orderDirection = order + " " + dir
	final = "%" + strings.ToLower(search) + "%"
	res := db.connection.Debug().Table("internal_memos").Select("internal_memos.id, internal_memos.internal_memo_no, to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY') as internal_memo_date, internal_memos.internal_memo_type_id, internal_memos.perihal_others, internal_memo_types.internal_memo_type_name, internal_memos.return_to_employee_id, returnToEmployeeID.firstname AS return_to_employee_name, internal_memos.document_no, internal_memos.company_id, companies.company_name, internal_memos.related_party, internal_memos.amount, internal_memos.amount_note, internal_memos.internal_memo_description, internal_memos.internal_memo_result, internal_memos.total_circulation, internal_memos.last_circulation_sequence_no, internal_memos.last_circulation_employee_id, lastCirculationEmployeeName.firstname AS last_circulation_employee_name, internal_memos.status, CASE WHEN internal_memos.status = 1 THEN 'Draft' WHEN internal_memos.status = 2 THEN 'Ask for Approval' WHEN internal_memos.status = 3 THEN 'Back to PIC' WHEN internal_memos.status = 4 THEN 'Approval Completed' WHEN internal_memos.status = 5 THEN 'Rejected' END AS status_name, internal_memos.remark, internal_memos.created_user_id, createdUID.username AS created_user, internal_memos.updated_user_id, updatedUID.username AS updated_user, internal_memos.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(internal_memos.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(internal_memos.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(internal_memos.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, internal_memos.file_name, internal_memos.file_url").Joins("left join companies on internal_memos.company_id = companies.id").Joins("left join internal_memo_types on internal_memos.internal_memo_type_id = internal_memo_types.id").Joins("left join employees returnToEmployeeID on internal_memos.return_to_employee_id = returnToEmployeeID.id").Joins("left join employees lastCirculationEmployeeName on internal_memos.last_circulation_employee_id = lastCirculationEmployeeName.id").Joins("left join users createdUID on internal_memos.created_user_id = createdUID.id").Joins("left join users updatedUID on internal_memos.updated_user_id = updatedUID.id").Joins("left join users deletedUID on internal_memos.deleted_user_id = deletedUID.id").Where("(lower(internal_memos.perihal_others) LIKE ? OR lower(internal_memos.internal_memo_no::text) LIKE ? OR lower(to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(internal_memo_types.internal_memo_type_name) LIKE ? OR lower(returnToEmployeeID.firstname) LIKE ? OR lower(internal_memos.document_no::text) LIKE ? OR lower(companies.company_name) LIKE ? OR lower(internal_memos.related_party) LIKE ? OR lower(internal_memos.amount::text) LIKE ? OR lower(internal_memos.amount_note) LIKE ? OR lower(internal_memos.internal_memo_description) LIKE ? OR lower(internal_memos.internal_memo_result) LIKE ? OR lower(to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(internal_memos.total_circulation::text) LIKE ? OR lower(internal_memos.last_circulation_sequence_no::text) LIKE ? OR lower(lastCirculationEmployeeName.firstname) LIKE ? OR (CASE WHEN internal_memos.status = 1 THEN 'draft' WHEN internal_memos.status = 2 THEN 'ask for approval' WHEN internal_memos.status = 3 THEN 'back to pic' WHEN internal_memos.status = 4 THEN 'approval completed' WHEN internal_memos.status = 5 THEN 'rejected' END LIKE ?) OR lower(internal_memos.remark) LIKE ? OR lower(createdUID.username) LIKE ? OR lower(to_char(to_timestamp(internal_memos.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(internal_memos.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND internal_memos.return_to_employee_id = ? AND internal_memos.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, employeeID).Order(orderDirection).Limit(limit).Offset(offset).Find(&internalMemos)
	return internalMemos, res.Error
}

func (db *InternalMemoConnection) CountSearchInternalMemo(search string, employeeID int) (internalMemoOutput []model.SelectInternalMemoParameter, err error) {
	var (
		final         string
		internalMemos []model.SelectInternalMemoParameter
	)
	final = "%" + strings.ToLower(search) + "%"
	res := db.connection.Debug().Table("internal_memos").Select("internal_memos.id, internal_memos.internal_memo_no, to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY') as internal_memo_date, internal_memos.internal_memo_type_id, internal_memos.perihal_others, internal_memo_types.internal_memo_type_name, internal_memos.return_to_employee_id, returnToEmployeeID.firstname AS return_to_employee_name, internal_memos.document_no, internal_memos.company_id, companies.company_name, internal_memos.related_party, internal_memos.amount, internal_memos.amount_note, internal_memos.internal_memo_description, internal_memos.internal_memo_result, internal_memos.total_circulation, internal_memos.last_circulation_sequence_no, internal_memos.last_circulation_employee_id, lastCirculationEmployeeName.firstname AS last_circulation_employee_name, internal_memos.status, CASE WHEN internal_memos.status = 1 THEN 'Draft' WHEN internal_memos.status = 2 THEN 'Ask for Approval' WHEN internal_memos.status = 3 THEN 'Back to PIC' WHEN internal_memos.status = 4 THEN 'Approval Completed' WHEN internal_memos.status = 5 THEN 'Rejected' END AS status_name, internal_memos.remark, internal_memos.created_user_id, createdUID.username AS created_user, internal_memos.updated_user_id, updatedUID.username AS updated_user, internal_memos.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(internal_memos.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(internal_memos.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(internal_memos.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, internal_memos.file_name, internal_memos.file_url").Joins("left join companies on internal_memos.company_id = companies.id").Joins("left join internal_memo_types on internal_memos.internal_memo_type_id = internal_memo_types.id").Joins("left join employees returnToEmployeeID on internal_memos.return_to_employee_id = returnToEmployeeID.id").Joins("left join employees lastCirculationEmployeeName on internal_memos.last_circulation_employee_id = lastCirculationEmployeeName.id").Joins("left join users createdUID on internal_memos.created_user_id = createdUID.id").Joins("left join users updatedUID on internal_memos.updated_user_id = updatedUID.id").Joins("left join users deletedUID on internal_memos.deleted_user_id = deletedUID.id").Where("(lower(internal_memos.perihal_others) LIKE ? OR lower(internal_memos.internal_memo_no::text) LIKE ? OR lower(to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(internal_memo_types.internal_memo_type_name) LIKE ? OR lower(returnToEmployeeID.firstname) LIKE ? OR lower(internal_memos.document_no::text) LIKE ? OR lower(companies.company_name) LIKE ? OR lower(internal_memos.related_party) LIKE ? OR lower(internal_memos.amount::text) LIKE ? OR lower(internal_memos.amount_note) LIKE ? OR lower(internal_memos.internal_memo_description) LIKE ? OR lower(internal_memos.internal_memo_result) LIKE ? OR lower(to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(internal_memos.total_circulation::text) LIKE ? OR lower(internal_memos.last_circulation_sequence_no::text) LIKE ? OR lower(lastCirculationEmployeeName.firstname) LIKE ? OR (CASE WHEN internal_memos.status = 1 THEN 'draft' WHEN internal_memos.status = 2 THEN 'ask for approval' WHEN internal_memos.status = 3 THEN 'back to pic' WHEN internal_memos.status = 4 THEN 'approval completed' WHEN internal_memos.status = 5 THEN 'rejected' END LIKE ?) OR lower(internal_memos.remark) LIKE ? OR lower(createdUID.username) LIKE ? OR lower(to_char(to_timestamp(internal_memos.created_at::numeric), 'DD-Mon-YYYY')) LIKE ? OR lower(updatedUID.username) LIKE ? OR lower(to_char(to_timestamp(internal_memos.updated_at::numeric), 'DD-Mon-YYYY')) LIKE ?) AND internal_memos.return_to_employee_id = ? AND internal_memos.deleted_at = 0", final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, final, employeeID).Find(&internalMemos)
	return internalMemos, res.Error
}

func (db *InternalMemoConnection) CountInternalMemoByDept(deptName string) (count int64, err error) {
	res := db.connection.Debug().Table("internal_memos").Select("internal_memos.id, internal_memos.internal_memo_no, to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY') as internal_memo_date, internal_memos.internal_memo_type_id, internal_memos.perihal_others, internal_memo_types.internal_memo_type_name, internal_memos.return_to_employee_id, returnToEmployeeID.firstname AS return_to_employee_name, internal_memos.document_no, internal_memos.company_id, companies.company_name, internal_memos.related_party, internal_memos.amount, internal_memos.amount_note, internal_memos.internal_memo_description, internal_memos.internal_memo_result, internal_memos.total_circulation, internal_memos.last_circulation_sequence_no, internal_memos.last_circulation_employee_id, lastCirculationEmployeeName.firstname AS last_circulation_employee_name, internal_memos.status, CASE WHEN internal_memos.status = 1 THEN 'Draft' WHEN internal_memos.status = 2 THEN 'Ask for Approval' WHEN internal_memos.status = 3 THEN 'Back to PIC' WHEN internal_memos.status = 4 THEN 'Approval Completed' WHEN internal_memos.status = 5 THEN 'Rejected' END AS status_name, internal_memos.remark, internal_memos.created_user_id, createdUID.username AS created_user, internal_memos.updated_user_id, updatedUID.username AS updated_user, internal_memos.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(internal_memos.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(internal_memos.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(internal_memos.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, internal_memos.file_name, internal_memos.file_url").Joins("left join companies on internal_memos.company_id = companies.id").Joins("left join internal_memo_types on internal_memos.internal_memo_type_id = internal_memo_types.id").Joins("left join employees returnToEmployeeID on internal_memos.return_to_employee_id = returnToEmployeeID.id").Joins("left join employees lastCirculationEmployeeName on internal_memos.last_circulation_employee_id = lastCirculationEmployeeName.id").Joins("left join users createdUID on internal_memos.created_user_id = createdUID.id").Joins("left join users updatedUID on internal_memos.updated_user_id = updatedUID.id").Joins("left join users deletedUID on internal_memos.deleted_user_id = deletedUID.id").Where("SPLIT_PART(internal_memos.internal_memo_no, '/', '1') LIKE ? AND to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'YYYY-MM-DD') = TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD') AND internal_memos.deleted_at = 0", deptName).Count(&count)
	return count, res.Error
}

func (db *InternalMemoConnection) FindInternalMemoById(id uint) (internalMemoOutput model.SelectInternalMemoParameter, err error) {
	var (
		internalMemo model.SelectInternalMemoParameter
	)
	res := db.connection.Debug().Table("internal_memos").Select("internal_memos.id, internal_memos.internal_memo_no, to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY') as internal_memo_date, internal_memos.internal_memo_type_id, internal_memos.perihal_others, internal_memo_types.internal_memo_type_name, internal_memos.return_to_employee_id, returnToEmployeeID.firstname AS return_to_employee_name, internal_memos.document_no, internal_memos.company_id, companies.company_name, internal_memos.related_party, internal_memos.amount, internal_memos.amount_note, internal_memos.internal_memo_description, internal_memos.internal_memo_result, internal_memos.total_circulation, internal_memos.last_circulation_sequence_no, internal_memos.last_circulation_employee_id, lastCirculationEmployeeName.firstname AS last_circulation_employee_name, internal_memos.status, CASE WHEN internal_memos.status = 1 THEN 'Draft' WHEN internal_memos.status = 2 THEN 'Ask for Approval' WHEN internal_memos.status = 3 THEN 'Back to PIC' WHEN internal_memos.status = 4 THEN 'Approval Completed' WHEN internal_memos.status = 5 THEN 'Rejected' END AS status_name, internal_memos.remark, internal_memos.created_user_id, createdUID.username AS created_user, internal_memos.updated_user_id, updatedUID.username AS updated_user, internal_memos.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(internal_memos.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(internal_memos.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(internal_memos.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, internal_memos.file_name, internal_memos.file_url").Joins("left join companies on internal_memos.company_id = companies.id").Joins("left join internal_memo_types on internal_memos.internal_memo_type_id = internal_memo_types.id").Joins("left join employees returnToEmployeeID on internal_memos.return_to_employee_id = returnToEmployeeID.id").Joins("left join employees lastCirculationEmployeeName on internal_memos.last_circulation_employee_id = lastCirculationEmployeeName.id").Joins("left join users createdUID on internal_memos.created_user_id = createdUID.id").Joins("left join users updatedUID on internal_memos.updated_user_id = updatedUID.id").Joins("left join users deletedUID on internal_memos.deleted_user_id = deletedUID.id").Where("internal_memos.id=? AND internal_memos.deleted_at = 0", id).Take(&internalMemo)
	return internalMemo, res.Error
}

func (db *InternalMemoConnection) FindExcInternalMemo(id uint) (internalMemoOutput []model.SelectInternalMemoParameter, err error) {
	var (
		internalMemos []model.SelectInternalMemoParameter
	)
	res := db.connection.Debug().Table("internal_memos").Select("internal_memos.id, internal_memos.internal_memo_no, to_char(to_timestamp(internal_memos.internal_memo_date::numeric), 'DD-Mon-YYYY') as internal_memo_date, internal_memos.internal_memo_type_id, internal_memos.perihal_others, internal_memo_types.internal_memo_type_name, internal_memos.return_to_employee_id, returnToEmployeeID.firstname AS return_to_employee_name, internal_memos.document_no, internal_memos.company_id, companies.company_name, internal_memos.related_party, internal_memos.amount, internal_memos.amount_note, internal_memos.internal_memo_description, internal_memos.internal_memo_result, internal_memos.total_circulation, internal_memos.last_circulation_sequence_no, internal_memos.last_circulation_employee_id, lastCirculationEmployeeName.firstname AS last_circulation_employee_name, internal_memos.status, CASE WHEN internal_memos.status = 1 THEN 'Draft' WHEN internal_memos.status = 2 THEN 'Ask for Approval' WHEN internal_memos.status = 3 THEN 'Back to PIC' WHEN internal_memos.status = 4 THEN 'Approval Completed' WHEN internal_memos.status = 5 THEN 'Rejected' END AS status_name, internal_memos.remark, internal_memos.created_user_id, createdUID.username AS created_user, internal_memos.updated_user_id, updatedUID.username AS updated_user, internal_memos.deleted_user_id, deletedUID.username AS deleted_user, to_char(to_timestamp(internal_memos.created_at::numeric), 'DD-Mon-YYYY') as created_at, to_char(to_timestamp(internal_memos.updated_at::numeric), 'DD-Mon-YYYY') as updated_at, to_char(to_timestamp(internal_memos.deleted_at::numeric), 'DD-Mon-YYYY') as deleted_at, internal_memos.file_name, internal_memos.file_url").Joins("left join companies on internal_memos.company_id = companies.id").Joins("left join internal_memo_types on internal_memos.internal_memo_type_id = internal_memo_types.id").Joins("left join employees returnToEmployeeID on internal_memos.return_to_employee_id = returnToEmployeeID.id").Joins("left join employees lastCirculationEmployeeName on internal_memos.last_circulation_employee_id = lastCirculationEmployeeName.id").Joins("left join users createdUID on internal_memos.created_user_id = createdUID.id").Joins("left join users updatedUID on internal_memos.updated_user_id = updatedUID.id").Joins("left join users deletedUID on internal_memos.deleted_user_id = deletedUID.id").Where("internal_memos.id!=? AND internal_memos.deleted_at = 0", id).Order("internal_memos.internal_memo_no").Find(&internalMemos)
	return internalMemos, res.Error
}

func (db *InternalMemoConnection) InsertInternalMemo(internalMemo model.InternalMemo) (internalMemoOutput model.InternalMemo, err error) {
	res := db.connection.Save(&internalMemo)
	return internalMemo, res.Error
}

func (db *InternalMemoConnection) UpdateInternalMemo(internalMemo model.InternalMemo, id uint) (internalMemoOutput model.InternalMemo, err error) {
	res := db.connection.Where("id=?", id).Updates(&internalMemo)
	return internalMemo, res.Error
}

func (db *InternalMemoConnection) UpdateInternalMemoApprove(internalMemo model.InternalMemo, id uint) (internalMemoOutput model.InternalMemo, err error) {
	res := db.connection.Model(&internalMemo).Where("id=?", id).Updates(map[string]interface{}{"internal_memo_no": internalMemo.InternalMemoNo, "status": internalMemo.Status, "total_circulation": internalMemo.TotalCirculation, "last_circulation_sequence_no": internalMemo.LastCirculationSequenceNo, "last_circulation_employee_id": internalMemo.LastCirculationEmployeeID, "updated_user_id": internalMemo.UpdatedUserID, "updated_at": internalMemo.UpdatedAt})
	return internalMemo, res.Error
}

func (db *InternalMemoConnection) UploadIMDocument(internalMemo model.InternalMemo, id uint) (internalMemoOutput model.InternalMemo, err error) {
	res := db.connection.Model(&internalMemo).Where("id=?", id).Updates(map[string]interface{}{"internal_memo_no": internalMemo.InternalMemoNo, "file_url": internalMemo.FileUrl, "file_name": internalMemo.FileName, "updated_user_id": internalMemo.UpdatedUserID, "updated_at": internalMemo.UpdatedAt})
	return internalMemo, res.Error
}
